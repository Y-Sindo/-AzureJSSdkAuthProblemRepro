# Overview
Our customer uses Web PubSub JavaScript SDK in their Azure Functions App with `DefaultAzureCredential` for auth. They have found that the SDK sometimes keeps failing to auth to the Web PubSub service during peak load. After investigation, we repro the problem with a simple Function App sample. We customize the Web PubSub service SDK so that it can log the authentication header used to auth REST API call. We can find that the access token is cached for more than one day and not refreshed, thus expires.

# Repro steps
1. Update the `webPubSubResourceName` in `HttpTrigger1\index.ts` to the actual Web PubSub resource name.
2. Deploy the function with log analytic workspace. **Please make sure this environment variable is set: "AZURE_LOG_LEVEL":"verbose"**
3. Enable the managed identity of the function APP, and assign the identity a `Web PubSub Service Owner` role of the Web PubSub resource.
4. Replace the `FUNCTIONAPPNAME` in the `test.ps1` with the actual function app name. Then run the script for more than one day, as the access token generated by the SDK has a lifetime of one day. This script calls the function every 0.5s.
6. We can see 400 response which indicates the Web PubSub service call failed after one day. From the logs in functions, we can see the token is expired. You can view the log in Log Analytics workspace for function APP with query :
```
traces ;
```
![screenshot](Screenshot%202022-09-07%20114509.png)

# Our suspicion
The refresh of AAD access token is blocked when the function APP is busy with handling incoming requests.